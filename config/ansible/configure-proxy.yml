---
- name: Configure Proxy Settings
  hosts: all
  become: yes
  tasks:
    - name: Add proxy hostname entries to /etc/hosts
      blockinfile:
        path: /etc/hosts
        block: |
          10.0.0.1 proxy.xc
          10.0.0.254 proxy.xc
        marker: "# {mark} ANSIBLE MANAGED BLOCK - proxy.xc"
        backup: yes

    - name: Set proxy environment variables
      lineinfile:
        path: /etc/environment
        line: "{{ item }}"
        regexp: "^{{ item.split('=')[0] }}="
        backup: yes
      loop:
        - "http_proxy=http://proxy.xc:3128"
        - "https_proxy=http://proxy.xc:3128"
        - "no_proxy=localhost,127.0.0.1,10.0.0.0/24,10.10.10.0/24"

    - name: Configure apt proxy
      copy:
        dest: /etc/apt/apt.conf.d/01proxy
        content: |
          Acquire::http::Proxy "http://proxy.xc:3128";
          Acquire::https::Proxy "http://proxy.xc:3128";
        backup: yes

    - name: Update old curtin proxy configuration
      copy:
        dest: /etc/apt/apt.conf.d/90curtin-aptproxy
        content: |
          Acquire::http::Proxy "http://proxy.xc:3128";
          Acquire::https::Proxy "http://proxy.xc:3128";
        backup: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Get current snap proxy settings
      command: snap get system proxy.http
      register: snap_http_proxy
      failed_when: false
      changed_when: false

    - name: Set snap proxy settings
      command: "{{ item }}"
      loop:
        - "snap set system proxy.http=http://proxy.xc:3128"
        - "snap set system proxy.https=http://proxy.xc:3128"
      when: 
        - ansible_facts['os_family'] == "Debian"
        - snap_http_proxy.stdout != "http://proxy.xc:3128"
      become: yes
