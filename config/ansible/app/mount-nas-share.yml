---
# Mount NAS share on cluster nodes
#
# Usage:
#   ansible-playbook app/mount-nas-share.yml
#   ansible-playbook app/mount-nas-share.yml --limit core
#   ansible-playbook app/mount-nas-share.yml --limit macos
#
# Prerequisites:
#   - NAS node running with Samba configured (see setup-nas.yml)
#   - vault_samba_secret defined in vault

- name: Mount NAS share on Linux nodes
  hosts: core:compute
  become: yes
  vars:
    samba_user: cluster
    samba_share_name: near1
    nas_host: nas1.xc
    mount_point: /near1
    mount_uid: 1000
    mount_gid: 1000

  tasks:
    - name: Install CIFS utilities
      apt:
        name: cifs-utils
        state: present
        update_cache: yes

    - name: Create mount point
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: '0755'

    - name: Create credentials directory
      file:
        path: /etc/samba
        state: directory
        mode: '0755'

    - name: Create credentials file
      copy:
        dest: /etc/samba/nas-credentials
        content: |
          username={{ samba_user }}
          password={{ vault_samba_secret }}
        mode: '0600'
      no_log: true

    - name: Create systemd mount unit
      copy:
        dest: /etc/systemd/system/near1.mount
        content: |
          [Unit]
          Description=NAS Share {{ samba_share_name }}
          After=network-online.target
          Wants=network-online.target

          [Mount]
          What=//{{ nas_host }}/{{ samba_share_name }}
          Where={{ mount_point }}
          Type=cifs
          Options=credentials=/etc/samba/nas-credentials,uid={{ mount_uid }},gid={{ mount_gid }},file_mode=0664,dir_mode=0775,_netdev,x-systemd.automount

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: reload systemd

    - name: Create systemd automount unit
      copy:
        dest: /etc/systemd/system/near1.automount
        content: |
          [Unit]
          Description=Automount NAS Share {{ samba_share_name }}
          After=network-online.target
          Wants=network-online.target

          [Automount]
          Where={{ mount_point }}
          TimeoutIdleSec=0

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: reload systemd

    - name: Flush handlers
      meta: flush_handlers

    - name: Enable and start automount
      systemd:
        name: near1.automount
        enabled: yes
        state: started

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes


- name: Mount NAS share on macOS nodes
  hosts: macos
  become: yes
  vars:
    samba_user: cluster
    samba_share_name: near1
    nas_host: nas1.xc
    mount_point: /Volumes/near1
    mount_user: dev
    mount_group: staff

  tasks:
    - name: Check if already mounted
      command: mount
      register: mount_check
      changed_when: false

    - name: Create mount point
      file:
        path: "{{ mount_point }}"
        state: directory
        owner: "{{ mount_user }}"
        group: "{{ mount_group }}"
        mode: '0755'
      when: mount_point not in mount_check.stdout

    - name: Create credentials file
      copy:
        dest: /etc/nas-credentials
        content: |
          username={{ samba_user }}
          password={{ vault_samba_secret }}
        owner: "{{ mount_user }}"
        group: wheel
        mode: '0600'
      no_log: true



    - name: Create /usr/local/bin directory
      file:
        path: /usr/local/bin
        state: directory
        mode: '0755'

    - name: Create mount script
      copy:
        dest: /usr/local/bin/mount-near1.sh
        content: |
          #!/bin/bash
          # Mount NAS share (launchd runs this periodically via StartInterval)

          MOUNT_POINT="{{ mount_point }}"
          NAS_HOST="{{ nas_host }}"
          SHARE_NAME="{{ samba_share_name }}"
          CREDS_FILE="/etc/nas-credentials"

          # Read credentials
          USERNAME=$(grep '^username=' "$CREDS_FILE" | cut -d= -f2)
          PASSWORD=$(grep '^password=' "$CREDS_FILE" | cut -d= -f2)

          # Check if mounted and healthy
          if mount | grep -q "$MOUNT_POINT"; then
              # Test if the mount is actually responsive (2s timeout)
              if stat -f %T "$MOUNT_POINT" >/dev/null 2>&1 & STAT_PID=$!; then
                  sleep 2
                  if kill -0 "$STAT_PID" 2>/dev/null; then
                      # stat is hung â€” mount is stale
                      kill "$STAT_PID" 2>/dev/null
                      wait "$STAT_PID" 2>/dev/null
                      echo "$(date): Stale mount detected, force unmounting"
                      diskutil unmount force "$MOUNT_POINT" 2>/dev/null || umount -f "$MOUNT_POINT" 2>/dev/null
                      sleep 1
                  else
                      wait "$STAT_PID"
                      if [ $? -eq 0 ]; then
                          # Mount is healthy
                          exit 0
                      else
                          echo "$(date): Mount check failed, force unmounting"
                          diskutil unmount force "$MOUNT_POINT" 2>/dev/null || umount -f "$MOUNT_POINT" 2>/dev/null
                          sleep 1
                      fi
                  fi
              fi
          fi

          # Ensure mount point exists (script runs as root via launchd)
          mkdir -p "$MOUNT_POINT"
          chown {{ mount_user }}:{{ mount_group }} "$MOUNT_POINT"

          echo "$(date): Mounting //$NAS_HOST/$SHARE_NAME to $MOUNT_POINT"

          # Mount as dev so files are owned by dev
          if su -l {{ mount_user }} -c "/sbin/mount_smbfs -f 0664 -d 0775 '//$USERNAME:$PASSWORD@$NAS_HOST/$SHARE_NAME' '$MOUNT_POINT'"; then
              echo "$(date): Mount successful"
              exit 0
          else
              echo "$(date): Mount failed, will retry next interval"
              exit 1
          fi
        mode: '0755'

    - name: Create LaunchDaemon for auto-mount
      copy:
        dest: /Library/LaunchDaemons/com.ycluster.mount-near1.plist
        content: |
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.ycluster.mount-near1</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/usr/local/bin/mount-near1.sh</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>StartInterval</key>
              <integer>60</integer>
              <key>StandardOutPath</key>
              <string>/tmp/mount-near1.log</string>
              <key>StandardErrorPath</key>
              <string>/tmp/mount-near1.log</string>
          </dict>
          </plist>
        mode: '0644'
      notify: load launchdaemon

    - name: Mount now (if not already mounted)
      shell: |
        if ! mount | grep -q "{{ mount_point }}"; then
          /usr/local/bin/mount-near1.sh &
        fi
      changed_when: false

  handlers:
    - name: load launchdaemon
      shell: |
        launchctl unload /Library/LaunchDaemons/com.ycluster.mount-near1.plist 2>/dev/null || true
        launchctl load /Library/LaunchDaemons/com.ycluster.mount-near1.plist
