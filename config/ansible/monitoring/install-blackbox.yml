---
- name: Install Blackbox Exporter
  hosts: core:frontend
  become: yes
  
  tasks:
    - name: Install Blackbox Exporter
      apt:
        name: prometheus-blackbox-exporter
        state: present

    - name: Create blackbox TLS directory
      file:
        path: /etc/blackbox_exporter/tls
        state: directory
        mode: '0755'
        owner: prometheus
        group: prometheus

    - name: Check if CA exists
      stat:
        path: /rbd/misc/ca/ca.crt
      register: ca_exists
      when: storage_leader

    - name: Generate CA if not exists (storage leader only)
      command: /usr/local/bin/ycluster tls ca generate
      when: 
        - storage_leader
        - not ca_exists.stat.exists

    - name: Generate server certificates for each blackbox host
      command: /usr/local/bin/ycluster tls ca generate-server {{ item }} --san {{ hostvars[item]['ansible_host'] }} --san localhost --san 127.0.0.1
      loop: "{{ groups['core'] + groups['frontend'] }}"
      when: storage_leader
      ignore_errors: yes  # Certificate might already exist

    - name: Fetch CA certificate from storage leader to control machine
      fetch:
        src: /rbd/misc/ca/ca.crt
        dest: /tmp/blackbox-ca.crt
        flat: yes
      when: storage_leader

    - name: Fetch server certificates from storage leader to control machine
      fetch:
        src: /rbd/misc/ca/certs/{{ item }}.crt
        dest: /tmp/blackbox-{{ item }}.crt
        flat: yes
      loop: "{{ groups['core'] + groups['frontend'] }}"
      when: storage_leader

    - name: Fetch server keys from storage leader to control machine
      fetch:
        src: /rbd/misc/ca/certs/{{ item }}.key
        dest: /tmp/blackbox-{{ item }}.key
        flat: yes
      loop: "{{ groups['core'] + groups['frontend'] }}"
      when: storage_leader

    - name: Copy CA certificate to all blackbox hosts
      copy:
        src: /tmp/blackbox-ca.crt
        dest: /etc/blackbox_exporter/tls/ca.crt
        owner: prometheus
        group: prometheus
        mode: '0644'

    - name: Copy server certificate to all blackbox hosts
      copy:
        src: /tmp/blackbox-{{ inventory_hostname }}.crt
        dest: /etc/blackbox_exporter/tls/server.crt
        owner: prometheus
        group: prometheus
        mode: '0644'

    - name: Copy server private key to all blackbox hosts
      copy:
        src: /tmp/blackbox-{{ inventory_hostname }}.key
        dest: /etc/blackbox_exporter/tls/server.key
        owner: prometheus
        group: prometheus
        mode: '0600'

    - name: Create blackbox exporter web config for TLS
      copy:
        content: |
          tls_server_config:
            cert_file: /etc/blackbox_exporter/tls/server.crt
            key_file: /etc/blackbox_exporter/tls/server.key
            client_ca_file: /etc/blackbox_exporter/tls/ca.crt
            client_auth_type: RequireAndVerifyClientCert
        dest: /etc/blackbox_exporter/web-config.yml
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: restart blackbox exporter

    - name: Configure blackbox exporter default args for TLS
      copy:
        content: |
          # Arguments for blackbox exporter
          ARGS="--config.file=/etc/prometheus/blackbox.yml --web.config.file=/etc/blackbox_exporter/web-config.yml --web.listen-address=:9115"
        dest: /etc/default/prometheus-blackbox-exporter
        mode: '0644'
      notify: restart blackbox exporter

    - name: Enable and start Blackbox Exporter
      systemd:
        name: prometheus-blackbox-exporter
        enabled: yes
        state: started

  handlers:
    - name: restart blackbox exporter
      systemd:
        name: prometheus-blackbox-exporter
        state: restarted
