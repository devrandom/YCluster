---
- name: Install YCluster Python package
  hosts: storage:compute
  become: yes
  vars:
    ycluster_package_dir: /opt/ycluster
    
  tasks:
    - name: Install Python dependencies and package tools
      apt:
        name:
          - python3-pip
          - python3-setuptools
          - python3-wheel
          - rsync
          # ycluster dependencies (prefer apt over pip)
          - python3-etcd3
          - python3-flask
          - python3-scapy
          - python3-requests
          - python3-dnspython
          - python3-cryptography
          - python3-jinja2
          - python3-netifaces
          - python3-yaml
          - python3-ntplib
          - python3-protobuf
          - python3-grpcio
        state: present

    - name: Remove pip-installed packages that shadow apt versions
      pip:
        name:
          - dnspython
          - grpcio
          - itsdangerous
          - ntplib
          - protobuf
          - scapy
          - tenacity
          - typing_extensions
          - werkzeug
          - blinker
          - flask
        state: absent
        extra_args: "--break-system-packages"
      failed_when: false

    - name: Check if YCluster package is installed
      command: python3 -c "import ycluster"
      register: ycluster_check
      changed_when: false
      failed_when: false

    - name: Copy YCluster package files
      synchronize:
        src: files/ycluster/
        dest: "{{ ycluster_package_dir }}/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--checksum"
          - "--no-owner"
          - "--no-group"
          - "--chmod=D0755,F0644"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=build"
          - "--exclude=*.egg-info"
      register: ycluster_sync

    - name: Install YCluster package (no deps - all dependencies from apt)
      pip:
        name: "{{ ycluster_package_dir }}"
        editable: no
        state: present
        extra_args: "--break-system-packages --no-deps"
      when: ycluster_check.rc != 0 or ycluster_sync.changed

    - name: Create backward compatibility wrapper scripts
      copy:
        dest: "/usr/local/bin/{{ item.script }}"
        mode: '0755'
        content: |
          #!/bin/bash
          # Backward compatibility wrapper for {{ item.script }}
          exec ycluster {{ item.command }} "$@"
      loop:
        - { script: 'lease-manager', command: 'dhcp' }
        - { script: 'https-config', command: 'https' }
        - { script: 'certbot-manager', command: 'certbot' }
        - { script: 'frontend-manager', command: 'frontend' }
        - { script: 'tls-config', command: 'tls' }
        - { script: 'rathole-config', command: 'rathole' }

    - name: Ensure bash completion directory exists
      file:
        path: /etc/bash_completion.d
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Verify YCluster installation
      command: ycluster --version
      register: ycluster_version
      changed_when: false

    - name: Display YCluster version
      debug:
        msg: "YCluster installed successfully: {{ ycluster_version.stdout }}"

    - name: Generate bash completion script
      shell: ycluster --completion > /etc/bash_completion.d/ycluster-completion.bash
      args:
        creates: /etc/bash_completion.d/ycluster-completion.bash
