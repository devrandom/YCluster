#!/bin/bash
# Capture Ansible vault password and store it in /run/shm/.vault-pass
# This file is stored in tmpfs and will be cleared on reboot

set -e

VAULT_PASS_FILE="/run/shm/.vault-pass"

# Check if password already exists
if [ -f "$VAULT_PASS_FILE" ]; then
    echo "Vault password file already exists at $VAULT_PASS_FILE"
    read -p "Overwrite? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Prompt for password
echo "Enter Ansible vault password:"
read -s VAULT_PASS

if [ -z "$VAULT_PASS" ]; then
    echo "Error: Password cannot be empty"
    exit 1
fi

# Confirm password
echo "Confirm password:"
read -s VAULT_PASS_CONFIRM

if [ "$VAULT_PASS" != "$VAULT_PASS_CONFIRM" ]; then
    echo "Error: Passwords do not match"
    exit 1
fi

# Write password to file with secure permissions
umask 077
echo -n "$VAULT_PASS" > "$VAULT_PASS_FILE"

echo "Vault password saved to $VAULT_PASS_FILE"
echo "This file will be cleared on reboot."
