---
- name: Setup PXE boot infrastructure on storage nodes s1-s3
  hosts: core
  become: yes
    
  tasks:
    - name: Create TFTP directory structure
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/tftpboot
        - /var/lib/tftpboot/EFI
        - /var/lib/tftpboot/EFI/BOOT
        - /var/lib/tftpboot/grub
        - /var/lib/tftpboot/ubuntu

    - name: Check if Ubuntu ISO already exists
      stat:
        path: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
      register: iso_file

    - name: Check if Ubuntu ISO exists on ansible host
      stat:
        path: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
      register: ansible_host_iso
      delegate_to: localhost
      when: not iso_file.stat.exists

    - name: Copy Ubuntu ISO from ansible host
      copy:
        src: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
        dest: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
        mode: '0644'
      when: not iso_file.stat.exists and ansible_host_iso.stat.exists
      register: iso_copy_result

    - name: Download Ubuntu ISO from local server (fallback)
      get_url:
        url: http://10.0.0.254/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
        dest: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
        mode: '0644'
      register: local_iso_download
      ignore_errors: yes
      when: not iso_file.stat.exists and (not ansible_host_iso.stat.exists or iso_copy_result is failed)

    - name: Download Ubuntu ISO from Ubuntu servers (final fallback)
      get_url:
        url: https://releases.ubuntu.com/24.04.3/ubuntu-24.04.3-live-server-amd64.iso
        dest: /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso
        mode: '0644'
      when: not iso_file.stat.exists and (local_iso_download is failed or local_iso_download is skipped)

    - name: Check if netboot files exist
      stat:
        path: "{{ item }}"
      register: netboot_files
      loop:
        - /var/lib/tftpboot/ubuntu/vmlinuz
        - /var/lib/tftpboot/ubuntu/initrd

    - name: Get checksum of vmlinuz from ISO
      shell: |
        mount -o loop,ro /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso /mnt && \
        sha256sum /mnt/casper/hwe-vmlinuz | cut -d' ' -f1 && \
        umount /mnt
      register: iso_vmlinuz_checksum
      changed_when: false

    - name: Get checksum of extracted vmlinuz
      shell: sha256sum /var/lib/tftpboot/ubuntu/vmlinuz | cut -d' ' -f1
      register: extracted_vmlinuz_checksum
      changed_when: false
      when: netboot_files.results[0].stat.exists

    - name: Check if netboot files need update
      set_fact:
        netboot_needs_update: >-
          {{
            (netboot_files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0)
            or
            (extracted_vmlinuz_checksum.stdout | default('') != iso_vmlinuz_checksum.stdout)
          }}

    - name: Extract HWE netboot files from ISO
      shell: |
        mount -o loop,ro /var/lib/tftpboot/ubuntu/ubuntu-24.04.3-live-server-amd64.iso /mnt && \
        cp /mnt/casper/hwe-vmlinuz /var/lib/tftpboot/ubuntu/vmlinuz && \
        cp /mnt/casper/hwe-initrd /var/lib/tftpboot/ubuntu/initrd && \
        umount /mnt
      when: netboot_needs_update

    - name: Get PXE kernel version
      shell: file /var/lib/tftpboot/ubuntu/vmlinuz | grep -oP 'version \K[^ ]+'
      register: pxe_kernel_version
      changed_when: false

    - name: Display PXE kernel version
      debug:
        msg: "PXE kernel version: {{ pxe_kernel_version.stdout }}"

    - name: Check if EFI files already exist
      stat:
        path: "{{ item }}"
      register: efi_files
      loop:
        - /var/lib/tftpboot/EFI/BOOT/bootx64.efi
        - /var/lib/tftpboot/EFI/BOOT/grubx64.efi

    - name: Download and extract EFI boot files
      shell: |
        cd /tmp
        apt-get download shim-signed grub-efi-amd64-signed
        dpkg-deb --fsys-tarfile shim-signed*deb | tar x ./usr/lib/shim/shimx64.efi.signed.latest -O > /var/lib/tftpboot/EFI/BOOT/bootx64.efi
        dpkg-deb --fsys-tarfile grub-efi-amd64-signed*deb | tar x ./usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed -O > /var/lib/tftpboot/EFI/BOOT/grubx64.efi
        rm -f shim-signed*.deb grub-efi-amd64-signed*.deb
      when: efi_files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Create grub configuration for PXE boot
      copy:
        dest: /var/lib/tftpboot/grub/grub.cfg
        content: |
          set timeout=30
          set default=autoinstall

          menuentry "Boot from First Hard Disk (EFI)" --id local {
              search --set=root --file /efi/ubuntu/grub.cfg
              configfile /efi/ubuntu/grub.cfg
          }

          menuentry "Ubuntu 24.04 Server Autoinstall" --id autoinstall {
              linux (http,10.0.0.254)/ubuntu/vmlinuz ip=dhcp url=http://10.0.0.254/ubuntu/ubuntu-24.04.3-live-server-amd64.iso autoinstall cloud-config-url=http://10.0.0.254/autoinstall/user-data
              initrd (http,10.0.0.254)/ubuntu/initrd
          }

          menuentry "Ubuntu 24.04 Server Manual Install" --id manual {
              linux (http,10.0.0.254)/ubuntu/vmlinuz ip=dhcp url=http://10.0.0.254/ubuntu/ubuntu-24.04.3-live-server-amd64.iso cloud-init=disabled
              initrd (http,10.0.0.254)/ubuntu/initrd
          }
