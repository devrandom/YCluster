---
- name: Install ROCm on AMD GPU nodes
  hosts: compute
  become: yes
  vars:
    rocm_version: "6.4.4"
    # Pin kernel version compatible with amdgpu DKMS
    # HWE kernels (6.17+) break amdgpu DKMS builds
    rocm_kernel_version: "6.14.0-37-generic"
  tasks:
    - name: Display AMD GPU status
      debug:
        msg: "AMD GPU detected: {{ ansible_local.gpu.has_amd_gpu | default(false) }}"

    - name: End play for nodes without AMD GPU
      meta: end_host
      when: not (ansible_local.gpu.has_amd_gpu | default(false))

    # Kernel pinning: use a known-good kernel for amdgpu DKMS
    - name: Remove HWE kernel meta-package (prevents incompatible kernel upgrades)
      apt:
        name:
          - linux-image-generic-hwe-24.04
          - linux-headers-generic-hwe-24.04
        state: absent
      register: hwe_removed

    - name: Install pinned kernel
      apt:
        name:
          - "linux-image-{{ rocm_kernel_version }}"
          - "linux-headers-{{ rocm_kernel_version }}"
        state: present
        update_cache: yes

    - name: Find incompatible kernels to remove
      shell: >
        dpkg -l linux-image-*-generic linux-headers-*-generic 2>/dev/null |
        awk '/^ii/{print $2}' |
        grep -v '{{ rocm_kernel_version }}' |
        grep -v '6.8.0' |
        grep -v linux-image-generic |
        tr '\n' ' '
      register: incompatible_kernels
      changed_when: false

    - name: Remove incompatible kernels (keep pinned and GA)
      apt:
        name: "{{ incompatible_kernels.stdout.split() }}"
        state: absent
        purge: yes
      when: incompatible_kernels.stdout.strip() != ""
      register: kernels_removed

    - name: Update GRUB
      command: update-grub
      when: kernels_removed is changed

    - name: Install prerequisites
      apt:
        name:
          - curl
          - gnupg
          - build-essential
          - dkms
          - "linux-headers-{{ rocm_kernel_version }}"
        state: present

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Copy ROCm GPG key
      copy:
        src: rocm.gpg.key
        dest: /tmp/rocm.gpg.key
        mode: '0644'
      changed_when: false

    - name: Import and dearmor ROCm GPG key
      shell: gpg --dearmor < /tmp/rocm.gpg.key > /etc/apt/keyrings/rocm.gpg
      args:
        creates: /etc/apt/keyrings/rocm.gpg

    - name: Set proper permissions on GPG key
      file:
        path: /etc/apt/keyrings/rocm.gpg
        mode: '0644'

    - name: Clean up temporary GPG file
      file:
        path: /tmp/rocm.gpg.key
        state: absent
      changed_when: false

    - name: Add ROCm repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/{{ rocm_version }} noble main"
        state: present
        filename: rocm

    - name: Add amdgpu repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/amdgpu/{{ rocm_version }}/ubuntu noble main"
        state: present
        filename: amdgpu

    - name: Set ROCm package pinning preference
      copy:
        dest: /etc/apt/preferences.d/rocm-pin-600
        content: |
          Package: *
          Pin: release o=repo.radeon.com
          Pin-Priority: 600
        mode: '0644'

    - name: Update apt cache after adding ROCm repos
      apt:
        update_cache: yes

    - name: Install amdgpu-dkms driver
      apt:
        name: amdgpu-dkms
        state: present
      register: amdgpu_install

    - name: Check if amdgpu DKMS is built for current kernel
      shell: dkms status amdgpu | grep "{{ rocm_kernel_version }}.*installed"
      register: dkms_status
      changed_when: false
      failed_when: false

    - name: Get amdgpu DKMS version
      shell: dkms status amdgpu | head -1 | cut -d',' -f1 | sed 's/amdgpu\///'
      register: dkms_version
      changed_when: false
      when: dkms_status.rc != 0

    - name: Build amdgpu DKMS for current kernel
      command: dkms install amdgpu/{{ dkms_version.stdout }} -k {{ rocm_kernel_version }}
      when: dkms_status.rc != 0

    - name: Install ROCm packages
      apt:
        name:
          - rocm
          - rocm-validation-suite
        state: present

    - name: Add users to render and video groups
      user:
        name: "{{ item }}"
        groups:
          - render
          - video
        append: yes
      loop:
        - "{{ ansible_user | default('ubuntu') }}"

    - name: Verify ROCm installation
      command: /opt/rocm/bin/rocminfo
      register: rocminfo_output
      changed_when: false
      failed_when: false

    - name: Display ROCm info
      debug:
        msg: "{{ rocminfo_output.stdout_lines[:20] }}"
      when: rocminfo_output.rc == 0

    - name: Reboot required notice
      debug:
        msg: "NOTICE: Reboot required to run kernel {{ rocm_kernel_version }} (currently {{ ansible_facts['kernel'] }})"
      when: ansible_facts['kernel'] != rocm_kernel_version or amdgpu_install.changed
